<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kingthy.platform.mapper.basedata.StyleCategoryMapper" >
  <resultMap id="BaseResultMap" type="com.kingthy.platform.entity.basedata.StyleCategory" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
    <result column="modify_date" property="modifyDate" jdbcType="TIMESTAMP" />
    <result column="version" property="version" jdbcType="INTEGER" />
    <result column="uuid" property="uuid" jdbcType="VARCHAR" />
    <result column="orders" property="orders" jdbcType="INTEGER" />
    <result column="grade" property="grade" jdbcType="INTEGER" />
    <result column="parent_id" property="parentId" jdbcType="VARCHAR" />
    <result column="class_name" property="className" jdbcType="VARCHAR" />
    <result column="tree_path" property="treePath" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="BIT" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="creator" property="creator" jdbcType="VARCHAR" />
    <result column="modifier" property="modifier" jdbcType="VARCHAR" />
    <result column="del_flag" property="delFlag" jdbcType="BIT" />
  </resultMap>
  
  	<!-- 批量更新节点的父节点id -->
  	<update id="updateParentIdBatch" parameterType="java.util.Map">
		update style_category c set
			c.parent_id=#{target},
			c.modify_date = #{modifyDate},
			c.modifier = #{modifier}
		where 	
			c.parent_id=#{source}
		and
			c.del_flag is false		
	</update>
	
	<!-- 根据根节点uuid查询其所有子孙节点，包括他自己的uuid -->
	<select id="findChildUuidsByParentId" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT getChild_style_category(#{parentId})
	</select>
	
	<!-- 批量更新节点状态 -->
	<update id="updateStatusBatch" parameterType="java.util.Map">
	update style_category c set
			c.status=#{status},
			c.modify_date = #{modifyDate},
			c.modifier = #{modifier}
		where 	
			c.uuid
		in	
			<foreach collection="uuidString" item="categoryUuid" index="" open="(" close=")" separator=",">
				#{categoryUuid}
			</foreach>
	</update>
	
	<!-- 批量修改节点层级 -->
	<update id="updateGradeBatch" parameterType="java.util.Map">
		update style_category c set
				c.grade = c.grade + #{gradeChange}
			where 	
				c.del_flag is false		
			and
				c.uuid
			in	
				<foreach collection="uuidString" item="categoryUuid" index="" open="(" close=")" separator=",">
					#{categoryUuid}
				</foreach>
	</update>
	
	<!-- 根据uuid修改单个节点的父节点 -->
	<update id="updateParentId" parameterType="java.util.Map">
		update style_category c set
				c.parent_id = #{newParentId}
			where 	
				c.del_flag is false		
			and
				c.uuid = #{uuid}
	</update>
	
	<!-- 修改单个节点信息：描述、分类名等 -->
	<update id="updateStyle" parameterType="com.kingthy.platform.entity.basedata.StyleCategory">
		update style_category c set
				c.class_name = #{className},
				c.description = #{description},
				c.modify_date = #{modifyDate},
				c.modifier = #{modifier}
			where 	
				c.del_flag is false		
			and
				c.uuid = #{uuid}
	</update>
	
	<!-- 为树结构查询提供数据 -->
	<select id="getTree" resultType="com.kingthy.platform.dto.basedata.CategoryTreeDto">
		select class_name as className,grade,`uuid`,parent_id as parentId from style_category
		where 
			del_flag is false	
	</select>

	<update id ="updateGoodsNum">
	  UPDATE style_category sc
		SET cc.modify_date = NOW("YYYY-MM-DD HH:MM:SS"),
			sc.goods_num = (
				SELECT
					COUNT(g.id)
				FROM
					goods g
				WHERE
					goods_style_uuid = sc.uuid
			)
	</update>
</mapper>